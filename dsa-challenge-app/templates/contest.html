<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contest - DSA Challenge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/contest.css') }}?v=2">
</head>

<body>
    <!-- Start Overlay -->
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // GLOBAL CONFIG - USER MUST UPDATE THIS
        // If you are the organizer, replace this object with your Firebase Project Config
        const firebaseConfig = {
            apiKey: "AIzaSyBjmZ_u6qsoSIPS_k9mhBnpZaW7mr2EFmQ",
            authDomain: "atc-dsa-challenge-app.firebaseapp.com",
            projectId: "atc-dsa-challenge-app",
            storageBucket: "atc-dsa-challenge-app.firebasestorage.app",
            messagingSenderId: "1018564474911",
            appId: "1:1018564474911:web:71194a5ad3c164acd43d2a",
            measurementId: "G-2B77DHCJLH"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("üî• Firebase initialized");
        } catch (e) {
            console.error("Firebase Init Error (Did you update the config?):", e);
        }

        // Store Session Info
        // Priority: LocalStorage (Client-Side Reg) -> Template (Server-Side Reg)
        let PARTICIPANT_ID = localStorage.getItem('dsa_participant_id') || "{{ participant_id }}";
        let PARTICIPANT_NAME = localStorage.getItem('dsa_participant_name') || "{{ name }}";
        let PARTICIPANT_EMAIL = localStorage.getItem('dsa_participant_email') || "{{ email }}";

        // Auth Check
        if (!PARTICIPANT_ID || PARTICIPANT_ID === 'None' || PARTICIPANT_ID === '') {
            console.warn("No ID found, redirecting to login");
            window.location.href = '/';
        }
    </script>

    <div id="startOverlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white;">
        <h1>Ready to Begin?</h1>
        <p style="margin-bottom: 2rem; color: #cbd5e1;">Click below to enter fullscreen mode and start the timer.</p>
        <button id="enterFullscreenBtn"
            style="padding: 1rem 2rem; font-size: 1.2rem; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s;">
            Enter Contest
        </button>
    </div>

    <!-- Fullscreen Required Overlay -->
    <div id="fullscreenBlocker"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9998; justify-content: center; align-items: center; flex-direction: column; color: white;">
        <h1 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Fullscreen Required</h1>
        <p style="margin-bottom: 2rem; color: #cbd5e1; text-align: center; max-width: 600px;">
            You must be in fullscreen mode to participate.<br>
            Using split-screen or windowed mode is prohibited.
        </p>
        <button onclick="enableFullscreen()"
            style="padding: 1rem 2rem; font-size: 1.1rem; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Return to Contest
        </button>
    </div>

    <div class="contest-container">
        <!-- Warning Modal -->
        <div id="warningModal" class="modal" style="display: none;">
            <div class="modal-content warning">
                <h2>‚ö†Ô∏è Warning!</h2>
                <p id="warningText">You switched away from the contest window!</p>
                <p><strong>Violations: <span id="violationCount">0</span>/3</strong></p>
                <p>One more violation and you will be disqualified!</p>
                <button onclick="closeWarning()" class="btn-primary">I Understand</button>
            </div>
        </div>

        <!-- End Contest Confirmation Modal -->
        <div id="endContestModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>End Contest?</h2>
                <p>Are you sure you want to end the contest?</p>
                <p class="sub-text">This action cannot be undone.</p>
                <div class="modal-actions">
                    <button onclick="confirmEndContest()" class="btn-danger">Yes, End Contest</button>
                    <button onclick="cancelEndContest()" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Disqualification Modal -->
        <div id="disqualifyModal" class="modal" style="display: none;">
            <div class="modal-content error">
                <h2>‚ùå Disqualified!</h2>
                <p>You have been disqualified for switching away from the contest window 3 times.</p>
                <p>The contest has ended.</p>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="left-info">
                <span class="user-name">üë§ {{ name }}</span>
                <span class="violations">‚ö†Ô∏è Violations: <span id="topViolations">0</span>/3</span>
            </div>
            <div class="right-info">
                <span class="score" id="score">Score: 0/100</span>
                <span class="timer" id="timer">‚è± 02:00:00</span>
                <img src="{{ url_for('static', filename='images/atc_logo.png') }}" alt="ATC Logo"
                    style="width: 30px; height: 30px; margin-left: 15px; vertical-align: middle; border-radius: 50%;">
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Problems -->
            <div class="sidebar">
                <h3>üìù Problems</h3>
                <div id="problemList" class="problem-list"></div>
            </div>

            <!-- Center - Problem & Editor -->
            <div class="editor-section">
                <!-- Problem Description -->
                <div class="problem-panel">
                    <h3>Problem Description</h3>
                    <div id="problemDescription" class="problem-content">
                        Select a problem from the list to begin
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="editor-panel">
                    <div class="editor-header">
                        <h3>üíª Code Editor</h3>
                        <div class="language-selector">
                            <label for="language">Language:</label>
                            <select id="language">
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="codeEditor" class="code-editor" spellcheck="false"></textarea>
                </div>

                <!-- Error Display Panel -->
                <div id="errorPanel" class="error-panel" style="display: none;">
                    <div class="error-header">‚ö†Ô∏è Error Output</div>
                    <pre id="errorContent" class="error-content"></pre>
                </div>

                <!-- Action Buttons -->
                <div class="action-bar">
                    <button id="runBtn" class="btn btn-run">‚ñ∂ Run Code</button>
                    <button id="submitBtn" class="btn btn-submit">‚úì Submit</button>
                    <button id="endBtn" class="btn btn-end">End Contest</button>
                    <div id="result" class="result-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/contest.js') }}"></script>
</body>

</html>